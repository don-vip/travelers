travl_travel_effect = {
	if = {
		limit = {
			exists = $ORIGIN$
			exists = $RECEIVER$.capital_province
			NOT = { $ORIGIN$ = $RECEIVER$.capital_province }
			NOT = { var:travl_travel_receiver ?= $RECEIVER$ }
		}

		# Set leader travel variables
		travl_travel_set_variables_effect = {
			SENDER = $SENDER$
			RECEIVER = $RECEIVER$
			LEADER = this
			COMPANIONS = $COMPANIONS$
		}

		# Start leader travel plan
		current_travel_plan ?= {
			abort_travel_plan = yes
		}
		set_location = $ORIGIN$
		start_travel_plan = {
			destination = $RECEIVER$.capital_province
			return_trip = no
			on_start_on_action = travl_travel_on_departure
			on_arrival_on_action = travl_travel_on_arrival
			on_arrival_destinations = last
		}

		every_in_list = {
			list = $COMPANIONS$

			# Set companion travel variables
			travl_travel_set_variables_effect = {
				SENDER = $SENDER$
				RECEIVER = $RECEIVER$
				LEADER = prev
				COMPANIONS = $COMPANIONS$
			}

			# Start companion travel plan
			current_travel_plan ?= {
				abort_travel_plan = yes
			}
			set_location = $ORIGIN$
			start_travel_plan = {
				destination = $RECEIVER$.capital_province
				return_trip = no
				on_start_on_action = travl_travel_on_departure
				on_arrival_on_action = travl_travel_on_arrival
				on_arrival_destinations = last
			}
		}
	}
}

travl_abort_travel_effect = {
	if = {
		limit = {
			var:travl_travel_receiver ?= $RECEIVER$
		}

		# Save current location
		location = { save_scope_as = current_location }

		# Remove travel variables
		travl_travel_remove_variables_effect = yes

		# Abort travel plan
		current_travel_plan ?= {
			abort_travel_plan = yes
		}
		set_location = scope:current_location
	}
}

travl_travel_set_variables_effect = {
	set_variable = {
		name = travl_travel_sender
		value = $SENDER$
		years = 2
	}
	set_variable = {
		name = travl_travel_receiver
		value = $RECEIVER$
		years = 2
	}
	set_variable = {
		name = travl_travel_leader
		value = $LEADER$
		years = 2
	}
	save_temporary_scope_as = character
	every_in_list = {
		list = $COMPANIONS$
		scope:character = {
			add_to_variable_list = {
				name = travl_travel_companions
				target = prev
			}
		}
	}
}

travl_travel_remove_variables_effect = {
	if = {
		limit = { has_variable = travl_travel_sender }
		remove_variable = travl_travel_sender
	}
	if = {
		limit = { has_variable = travl_travel_receiver }
		remove_variable = travl_travel_receiver
	}
	if = {
		limit = { has_variable = travl_travel_leader }
		remove_variable = travl_travel_leader
	}
	if = {
		limit = { has_variable_list = travl_travel_companions }
		clear_variable_list = travl_travel_companions
	}
}

travl_travel_get_companions_effect = {
	if = {
		limit = { has_variable_list = travl_travel_companions }
		every_in_list = {
			variable = travl_travel_companions
			limit = { is_alive = yes }
			add_to_list = $COMPANIONS$
		}
	}
}

travl_travel_send_messages_effect = {
	save_temporary_scope_as = character

	if = {
		limit = {
			exists = $SENDER$
			travl_travel_should_send_message_trigger = { CHARACTER = $SENDER$ }
		}
		$SENDER$ = {
			send_interface_message = {
				type = event_generic_neutral
				title = $TITLE$
				right_icon = scope:character

				scope:character = {
					custom_description = {
						text = $TEXT$
						subject = this
						object = $RECEIVER$
					}
				}
				every_in_list = {
					list = $COMPANIONS$
					custom_description = {
						text = $TEXT$
						subject = this
						object = $RECEIVER$
					}
				}
			}
		}
	}
	else_if = {
		limit = {
			exists = $RECEIVER$
			travl_travel_should_send_message_trigger = { CHARACTER = $RECEIVER$ }
		}
		$RECEIVER$ = {
			send_interface_message = {
				type = event_generic_neutral
				title = $TITLE$
				right_icon = scope:character

				scope:character = {
					custom_description = {
						text = $TEXT$
						subject = this
						object = $RECEIVER$
					}
				}
				every_in_list = {
					list = $COMPANIONS$
					custom_description = {
						text = $TEXT$
						subject = this
						object = $RECEIVER$
					}
				}
			}
		}
	}
}

travl_set_receiver_effect = {
	if = {
		limit = {
			imprisoner ?= { travl_travel_is_valid_receiver_trigger = yes }
		}
		imprisoner = { save_scope_as = receiver }
	}
	else_if = {
		limit = {
			travl_travel_is_valid_receiver_trigger = yes
		}
		save_scope_as = receiver
	}
	else_if = {
		limit = {
			warden ?= { travl_travel_is_valid_receiver_trigger = yes }
		}
		warden = { save_scope_as = receiver }
	}
	else_if = {
		limit = {
			host ?= { travl_travel_is_valid_receiver_trigger = yes }
		}
		host = { save_scope_as = receiver }
	}
	else_if = {
		limit = {
			liege ?= { travl_travel_is_valid_receiver_trigger = yes }
		}
		liege = { save_scope_as = receiver }
	}
}

travl_imprison_effect = {
	$TARGET$ = {
		set_variable = {
			name = travl_location
			value = location
			days = 1
		}
	}
	imprison = {
		target = $TARGET$
		type = $TYPE$
	}
}
