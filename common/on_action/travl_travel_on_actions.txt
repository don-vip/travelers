travl_travel_on_departure = {
	trigger = {
		has_variable = travl_travel_sender
		has_variable = travl_travel_receiver
	}

	effect = {
		var:travl_travel_sender ?= { save_scope_as = sender }
		var:travl_travel_receiver ?= { save_scope_as = receiver }
		var:travl_travel_leader ?= { save_scope_as = leader }
		travl_travel_get_companions_effect = { COMPANIONS = companions }

		# Ensure the character is at the current location
		location = { save_scope_as = current_location }
		current_travel_plan ?= {
			current_location = { save_scope_as = current_location }
		}
		set_location = scope:current_location

		if = {
			limit = { scope:leader ?= this }

			# Send departure messages
			travl_travel_send_messages_effect = {
				SENDER = scope:sender
				RECEIVER = scope:receiver
				COMPANIONS = companions
				TITLE = travl_msg_departed_for_court
				TEXT = travl_departed_for_court_tt
			}
		}

		if = {
			limit = { scope:leader ?= this }
			travl_debug_log_effect = { MSG = travl_debug_msg_character_departed }
		}
		else_if = {
			limit = { exists = scope:leader }
			travl_debug_log_effect = { MSG = travl_debug_msg_character_departed_companion }
		}
	}
}

travl_travel_on_arrival = {
	trigger = {
		has_variable = travl_travel_sender
		has_variable = travl_travel_receiver
	}

	effect = {
		var:travl_travel_sender ?= { save_scope_as = sender }
		var:travl_travel_receiver ?= { save_scope_as = receiver }
		var:travl_travel_leader ?= { save_scope_as = leader }
		travl_travel_get_companions_effect = { COMPANIONS = companions }

		# Ensure the character is at the destination
		location = { save_scope_as = current_location }
		current_travel_plan ?= {
			final_destination_province = { save_scope_as = current_location }
		}
		set_location = scope:current_location

		if = {
			limit = { scope:leader ?= this }

			# Ensure companions arrive as well
			every_in_list = {
				list = companions
				current_travel_plan ?= {
					add_destination_progress = { years = 2 }
				}
			}

			# Send arrival messages
			travl_travel_send_messages_effect = {
				SENDER = scope:sender
				RECEIVER = scope:receiver
				COMPANIONS = companions
				TITLE = travl_msg_arrived_at_court
				TEXT = travl_arrived_at_court_tt
			}
		}

		if = {
			limit = { scope:leader ?= this }
			travl_debug_log_effect = { MSG = travl_debug_msg_character_arrived }
		}
		else_if = {
			limit = { exists = scope:leader }
			travl_debug_log_effect = { MSG = travl_debug_msg_character_arrived_companion }
		}

		# Remove travel variables
		travl_travel_remove_variables_effect = yes
	}
}

# Arrival in any province during travel
on_travel_plan_movement = {
	on_actions = { travl_on_travel_plan_movement }
}

travl_on_travel_plan_movement = {
	trigger = {
		has_variable = travl_travel_sender
		has_variable = travl_travel_receiver
	}

	effect = {
		#travl_debug_log_effect = { MSG = travl_debug_msg_travel_moved }

		var:travl_travel_sender ?= { save_scope_as = sender }
		var:travl_travel_receiver ?= { save_scope_as = receiver }
		var:travl_travel_leader ?= { save_scope_as = leader }
		travl_travel_get_companions_effect = { COMPANIONS = companions }
		var:travl_travel_event ?= { save_scope_as = event }

		# Ensure the character is at the current location
		location = { save_scope_as = current_location }
		current_travel_plan ?= {
			current_location = { save_scope_as = current_location }
		}
		set_location = scope:current_location

		# If the leader died, make root leader
		if = {
			limit = {
				scope:leader ?= {
					NOT = { this = prev }
					is_alive = no
				}
			}

			# Evaluate new leader and companions
			save_scope_as = leader
			remove_from_list = companions

			# Update leader and companions for all characters in the group
			travl_travel_update_leader_and_companions_effect = { COMPANIONS = companions }
		}

		# If the receiver is no longer valid, change receiver or cancel
		if = {
			limit = {
				scope:receiver ?= {
					OR = {
						is_alive = no
						is_landed = no
					}
				}
			}

			# Determine new receiver
			travl_set_receiver_effect = yes

			if = {
				limit = {
					scope:receiver ?= { is_landed = yes }
				}

				# Abort current travel plan
				current_travel_plan ?= {
					abort_travel_plan = yes
				}
				set_location = scope:current_location

				# Set travel variables
				travl_travel_set_variables_effect = {
					SENDER = scope:sender
					RECEIVER = scope:receiver
					LEADER = scope:leader
					COMPANIONS = companions
					EVENT = scope:event
				}

				# Start new travel plan
				start_travel_plan = {
					destination = scope:receiver.capital_province
					return_trip = no
					on_arrival_on_action = travl_travel_on_arrival
					on_arrival_destinations = last
				}

				travl_debug_log_effect = { MSG = travl_debug_msg_character_receiver_changed }
			}
			else = {
				# Cancel travel
				current_travel_plan ?= {
					cancel_travel_plan = yes
				}

				travl_debug_log_effect = { MSG = travl_debug_msg_character_travel_cancelled }

				# Remove travel variables
				travl_travel_remove_variables_effect = yes
			}
		}
		# If the receiver's capital province changed, reroute to new capital province
		else_if = {
			limit = {
				current_travel_plan ?= {
					NOT = { final_destination_province = scope:receiver.capital_province }
				}
			}

			# Abort current travel plan
			current_travel_plan ?= {
				abort_travel_plan = yes
			}
			set_location = scope:current_location

			# Start new travel plan
			start_travel_plan = {
				destination = scope:receiver.capital_province
				return_trip = no
				on_arrival_on_action = travl_travel_on_arrival
				on_arrival_destinations = last
			}

			travl_debug_log_effect = { MSG = travl_debug_msg_character_destination_changed }
		}
	}
}

# Starting a travel plan (starting to travel to the first destination)
on_travel_plan_start = {
	on_actions = { travl_on_travel_plan_start }
}

travl_on_travel_plan_start = {
	trigger = {
		has_variable = travl_travel_sender
		has_variable = travl_travel_receiver
	}

	effect = {
		#travl_debug_log_effect = { MSG = travl_debug_msg_travel_started }
	}
}

# Arrival in a destination province during travel (a travel plan can have multiple sequential destinations)
on_travel_plan_arrival = {
	on_actions = { travl_on_travel_plan_arrival }
}

travl_on_travel_plan_arrival = {
	trigger = {
		has_variable = travl_travel_sender
		has_variable = travl_travel_receiver
	}

	effect = {
		#travl_debug_log_effect = { MSG = travl_debug_msg_travel_arrived }
	}
}

# Completed a travel plan (arrived at final destination, or completed through script)
# A travel plan ends either via 'on_travel_plan_complete' or 'on_travel_plan_abort'
on_travel_plan_complete = {
	on_actions = { travl_on_travel_plan_complete }
}

travl_on_travel_plan_complete = {
	trigger = {
		has_variable = travl_travel_sender
		has_variable = travl_travel_receiver
	}

	effect = {
		#travl_debug_log_effect = { MSG = travl_debug_msg_travel_completed }
	}
}

# Aborted a travel plan (travel plan was not completed, or aborted through script)
# A travel plan ends either via 'on_travel_plan_complete' or 'on_travel_plan_abort'
# This usually means everyone gets teleported to their default location after this.
on_travel_plan_abort = {
	on_actions = { travl_on_travel_plan_abort }
}

travl_on_travel_plan_abort = {
	trigger = {
		has_variable = travl_travel_sender
		has_variable = travl_travel_receiver
	}

	effect = {
		#travl_debug_log_effect = { MSG = travl_debug_msg_travel_aborted }
	}
}

# Cancelled a travel plan. Travel plan was cancelled by player interaction, and has
# been rerouted back home. (the travel plan doesn't end yet until they arrive home)
# People in the travel plan were removed from associated activities.
on_travel_plan_cancel = {
	on_actions = { travl_on_travel_plan_cancel }
}

travl_on_travel_plan_cancel = {
	trigger = {
		has_variable = travl_travel_sender
		has_variable = travl_travel_receiver
	}

	effect = {
		#travl_debug_log_effect = { MSG = travl_debug_msg_travel_cancelled }
	}
}