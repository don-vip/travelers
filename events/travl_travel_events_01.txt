namespace = travl_travel

travl_travel.0001 = {
	scope = none
	hidden = yes

	immediate = {
		every_living_character = {
			# Track location of non-teleporting characters
			if = {
				limit = { travl_is_teleporting_character_trigger = no }

				if = {
					limit = { has_variable = travl_location }
					if = {
						limit = {
							NOT = { location = var:travl_location }
						}

						if = {
							limit = {
								NOR = {
									# Travelling and near their current location
									travl_is_near_current_location_trigger = yes

									# Baron at their capital
									AND = {
										is_landed = yes
										highest_held_title_tier = tier_barony
										location = capital_province
									}
								}
							}

							trigger_event = {
								on_action = travl_on_teleport
							}
						}

						set_variable = {
							name = travl_location
							value = location
						}
					}
				}
				else = {
					set_variable = {
						name = travl_location
						value = location
					}
				}

				# Determine receiver
				travl_set_receiver_effect = yes

				# Check current location
				if = {
					limit = {
						exists = scope:receiver
						exists = scope:receiver.capital_province
						NOR = {
							is_travelling = yes
							location = scope:receiver.capital_province
						}
					}

					travl_error_log_1_effect = {
						MSG = travl_error_msg_invalid_character_location_detected
						NAME1 = receiver TYPE1 = flag:character
					}

					trigger_event = {
						on_action = travl_on_invalid_location
					}
				}
			}
			else = {
				if = {
					limit = { has_variable = travl_location }
					remove_variable = travl_location
				}
			}
		}

		trigger_event = {
			id = travl_travel.0001
			days = 1
		}
	}
}
